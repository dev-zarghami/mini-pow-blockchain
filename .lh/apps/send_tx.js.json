{
    "sourceFile": "apps/send_tx.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1761995480368,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1761996843412,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,65 +1,58 @@\n // apps/send_tx.js\n-// create and sign a simple transaction (educational)\n-// usage: node apps/send_tx.js --fromPriv <privhex> --fromPub <pubhex> --to <address> --amount 10\n+// Create & sign a transaction (ECDSA) and send to node\n+// Run: node apps/send_tx.js --fromPriv <priv> --fromPub <pub> --to <address> --amount 10 [--fee 1] [--node http://localhost:3000]\n \n const axios = require('axios');\n const EC = require('elliptic').ec;\n-const ec = new EC('secp256k1');\n const crypto = require('crypto');\n const argv = require('minimist')(process.argv.slice(2));\n \n-const NODE = 'http://localhost:3000';\n+const ec = new EC('secp256k1');\n+const NODE = argv.node || 'http://localhost:3000';\n \n-function sha256Hex(buf) {\n-  return crypto.createHash('sha256').update(buf).digest('hex');\n-}\n-function stableStringify(obj) {\n-  return require('stable-stringify')(obj);\n-}\n+const sha256Hex = (b)=> crypto.createHash('sha256').update(b).digest('hex');\n+const stableStringify = require('stable-stringify');\n \n-(async () => {\n+(async ()=>{\n   const priv = argv.fromPriv;\n   const pub = argv.fromPub;\n   const to = argv.to;\n   const amount = Number(argv.amount);\n+  const fee = Number(argv.fee || 0);\n   if (!priv || !pub || !to || !amount) {\n-    console.error('Usage: node apps/send_tx.js --fromPriv <privhex> --fromPub <pubhex> --to <address> --amount <num>');\n+    console.error('Usage: node apps/send_tx.js --fromPriv <priv> --fromPub <pub> --to <address> --amount <num> [--fee <num>]');\n     process.exit(1);\n   }\n \n-  // fetch utxos\n-  const ut = await axios.get(`${NODE}/utxos/${pub}`);\n+  // Fetch UTXOs (address == RIPEMD160(SHA256(pub)))\n+  const sha = crypto.createHash('sha256').update(Buffer.from(pub,'hex')).digest();\n+  const fromAddress = crypto.createHash('ripemd160').update(sha).digest('hex');\n+\n+  const ut = await axios.get(`${NODE}/utxos/${fromAddress}`);\n   const utxos = ut.data.utxos;\n-  // pick utxos naive\n-  let selected = [];\n-  let sum = 0;\n+  let picked = [], sum = 0;\n   for (const u of utxos) {\n-    selected.push(u);\n-    sum += u.amount;\n-    if (sum >= amount) break;\n+    picked.push(u); sum += u.amount; if (sum >= amount + fee) break;\n   }\n-  if (sum < amount) {\n-    console.error('insufficient funds');\n-    process.exit(1);\n-  }\n-  const change = sum - amount - (argv.fee ? Number(argv.fee) : 0);\n-  const inputs = selected.map(s => ({ txid: s.txid, index: s.index, pubKey: pub }));\n+  if (sum < amount + fee) { console.error('insufficient funds'); process.exit(1); }\n+\n+  const change = sum - amount - fee;\n+  const inputs = picked.map(u => ({ txid: u.txid, index: u.index, pubKey: pub }));\n   const outputs = [{ address: to, amount }];\n-  if (change > 0) outputs.push({ address: pub, amount: change });\n+  if (change > 0) outputs.push({ address: fromAddress, amount: change });\n \n-  const tx = { inputs, outputs };\n-  // sign inputs (educational: signature = sign(txidForSigning))\n-  const txid = sha256Hex(Buffer.from(stableStringify({ inputs: tx.inputs.map(i => ({txid:i.txid,index:i.index})), outputs: tx.outputs })));\n-  // sign with priv\n+  const unsignedPayload = {\n+    inputs: inputs.map(i => ({ txid: i.txid, index: i.index })),\n+    outputs: outputs.map(o => ({ address: o.address, amount: o.amount }))\n+  };\n+  const msg = sha256Hex(Buffer.from(stableStringify(unsignedPayload)));\n+\n   const key = ec.keyFromPrivate(priv);\n-  const sig = key.sign(txid);\n-  const sigHex = Buffer.from(sig.toDER()).toString('hex');\n-  // attach signatures per input\n-  for (let i = 0; i < tx.inputs.length; i++) {\n-    tx.inputs[i].sig = sigHex;\n-  }\n-  tx.id = sha256Hex(Buffer.from(stableStringify({ inputs: tx.inputs.map(i => ({txid:i.txid,index:i.index})), outputs: tx.outputs })));\n-  // submit\n-  const res = await axios.post(`${NODE}/transactions`, tx);\n-  console.log('submitted', res.data);\n+  const sigDER = Buffer.from(key.sign(msg).toDER()).toString('hex');\n+\n+  const tx = { inputs: inputs.map(i => ({...i, sig: sigDER})), outputs };\n+  tx.id = sha256Hex(Buffer.from(stableStringify(unsignedPayload)));\n+\n+  const r = await axios.post(`${NODE}/transactions`, tx);\n+  console.log('submitted tx:', r.data);\n })();\n"
                },
                {
                    "date": 1762003136672,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,9 +10,8 @@\n const ec = new EC('secp256k1');\n const NODE = argv.node || 'http://localhost:3000';\n \n const sha256Hex = (b)=> crypto.createHash('sha256').update(b).digest('hex');\n-const stableStringify = require('stable-stringify');\n \n (async ()=>{\n   const priv = argv.fromPriv;\n   const pub = argv.fromPub;\n@@ -44,15 +43,15 @@\n   const unsignedPayload = {\n     inputs: inputs.map(i => ({ txid: i.txid, index: i.index })),\n     outputs: outputs.map(o => ({ address: o.address, amount: o.amount }))\n   };\n-  const msg = sha256Hex(Buffer.from(stableStringify(unsignedPayload)));\n+  const msg = sha256Hex(Buffer.from(JSON.stringify(unsignedPayload)));\n \n   const key = ec.keyFromPrivate(priv);\n   const sigDER = Buffer.from(key.sign(msg).toDER()).toString('hex');\n \n   const tx = { inputs: inputs.map(i => ({...i, sig: sigDER})), outputs };\n-  tx.id = sha256Hex(Buffer.from(stableStringify(unsignedPayload)));\n+  tx.id = sha256Hex(Buffer.from(JSON.stringify(unsignedPayload)));\n \n   const r = await axios.post(`${NODE}/transactions`, tx);\n   console.log('submitted tx:', r.data);\n })();\n"
                }
            ],
            "date": 1761995480368,
            "name": "Commit-0",
            "content": "// apps/send_tx.js\n// create and sign a simple transaction (educational)\n// usage: node apps/send_tx.js --fromPriv <privhex> --fromPub <pubhex> --to <address> --amount 10\n\nconst axios = require('axios');\nconst EC = require('elliptic').ec;\nconst ec = new EC('secp256k1');\nconst crypto = require('crypto');\nconst argv = require('minimist')(process.argv.slice(2));\n\nconst NODE = 'http://localhost:3000';\n\nfunction sha256Hex(buf) {\n  return crypto.createHash('sha256').update(buf).digest('hex');\n}\nfunction stableStringify(obj) {\n  return require('stable-stringify')(obj);\n}\n\n(async () => {\n  const priv = argv.fromPriv;\n  const pub = argv.fromPub;\n  const to = argv.to;\n  const amount = Number(argv.amount);\n  if (!priv || !pub || !to || !amount) {\n    console.error('Usage: node apps/send_tx.js --fromPriv <privhex> --fromPub <pubhex> --to <address> --amount <num>');\n    process.exit(1);\n  }\n\n  // fetch utxos\n  const ut = await axios.get(`${NODE}/utxos/${pub}`);\n  const utxos = ut.data.utxos;\n  // pick utxos naive\n  let selected = [];\n  let sum = 0;\n  for (const u of utxos) {\n    selected.push(u);\n    sum += u.amount;\n    if (sum >= amount) break;\n  }\n  if (sum < amount) {\n    console.error('insufficient funds');\n    process.exit(1);\n  }\n  const change = sum - amount - (argv.fee ? Number(argv.fee) : 0);\n  const inputs = selected.map(s => ({ txid: s.txid, index: s.index, pubKey: pub }));\n  const outputs = [{ address: to, amount }];\n  if (change > 0) outputs.push({ address: pub, amount: change });\n\n  const tx = { inputs, outputs };\n  // sign inputs (educational: signature = sign(txidForSigning))\n  const txid = sha256Hex(Buffer.from(stableStringify({ inputs: tx.inputs.map(i => ({txid:i.txid,index:i.index})), outputs: tx.outputs })));\n  // sign with priv\n  const key = ec.keyFromPrivate(priv);\n  const sig = key.sign(txid);\n  const sigHex = Buffer.from(sig.toDER()).toString('hex');\n  // attach signatures per input\n  for (let i = 0; i < tx.inputs.length; i++) {\n    tx.inputs[i].sig = sigHex;\n  }\n  tx.id = sha256Hex(Buffer.from(stableStringify({ inputs: tx.inputs.map(i => ({txid:i.txid,index:i.index})), outputs: tx.outputs })));\n  // submit\n  const res = await axios.post(`${NODE}/transactions`, tx);\n  console.log('submitted', res.data);\n})();\n"
        }
    ]
}