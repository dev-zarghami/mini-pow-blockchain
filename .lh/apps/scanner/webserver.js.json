{
    "sourceFile": "apps/scanner/webserver.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1761997432137,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1761997617835,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,8 +5,9 @@\n const express = require('express');\n const path = require('path');\n const axios = require('axios');\n const { WebSocketServer } = require('ws');\n+const argv = require('minimist')(process.argv.slice(2));\n \n const NODE_URL = process.env.NODE_URL || 'http://localhost:3000';\n const PORT = process.env.SCANNER_PORT ? Number(process.env.SCANNER_PORT) : 8080;\n \n"
                },
                {
                    "date": 1761997661198,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,9 @@\n const axios = require('axios');\n const { WebSocketServer } = require('ws');\n const argv = require('minimist')(process.argv.slice(2));\n \n-const NODE_URL = process.env.NODE_URL || 'http://localhost:3000';\n+const NODE_URL = argv.node_url || 'http://localhost:3000';\n const PORT = process.env.SCANNER_PORT ? Number(process.env.SCANNER_PORT) : 8080;\n \n const app = express();\n \n"
                },
                {
                    "date": 1761997695056,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,9 @@\n const { WebSocketServer } = require('ws');\n const argv = require('minimist')(process.argv.slice(2));\n \n const NODE_URL = argv.node_url || 'http://localhost:3000';\n-const PORT = process.env.SCANNER_PORT ? Number(process.env.SCANNER_PORT) : 8080;\n+const PORT = argv.scanner_port ? Number(argv.scanner_port) : 8080;\n \n const app = express();\n \n // -------- Static files (Vue app) --------\n"
                },
                {
                    "date": 1761998232192,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,12 +5,11 @@\n const express = require('express');\n const path = require('path');\n const axios = require('axios');\n const { WebSocketServer } = require('ws');\n-const argv = require('minimist')(process.argv.slice(2));\n \n-const NODE_URL = argv.node_url || 'http://localhost:3000';\n-const PORT = argv.scanner_port ? Number(argv.scanner_port) : 8080;\n+const NODE_URL = process.env.NODE_URL || 'http://localhost:3000';\n+const PORT = process.env.SCANNER_PORT ? Number(process.env.SCANNER_PORT) : 8080;\n \n const app = express();\n \n // -------- Static files (Vue app) --------\n"
                },
                {
                    "date": 1762000551711,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,10 +6,10 @@\n const path = require('path');\n const axios = require('axios');\n const { WebSocketServer } = require('ws');\n \n-const NODE_URL = process.env.NODE_URL || 'http://localhost:3000';\n-const PORT = process.env.SCANNER_PORT ? Number(process.env.SCANNER_PORT) : 8080;\n+const NODE_URL = process.env.NODE_URL;\n+const PORT = Number(process.env.SCANNER_PORT);\n \n const app = express();\n \n // -------- Static files (Vue app) --------\n@@ -66,11 +66,11 @@\n   return mant << shift;\n }\n function formatHashrate(hps) {\n   if (!isFinite(hps) || hps <= 0) return '—';\n-  const units = ['H/s','kH/s','MH/s','GH/s','TH/s','PH/s','EH/s'];\n+  const units = ['H/s', 'kH/s', 'MH/s', 'GH/s', 'TH/s', 'PH/s', 'EH/s'];\n   let idx = 0;\n-  while (hps >= 1000 && idx < units.length-1) { hps /= 1000; idx++; }\n+  while (hps >= 1000 && idx < units.length - 1) { hps /= 1000; idx++; }\n   return `${hps.toFixed(2)} ${units[idx]}`;\n }\n function emitAll(msg) {\n   const data = JSON.stringify(msg);\n@@ -101,10 +101,10 @@\n       // estimate stats\n       let avgBlockSec = NaN;\n       if (blockTimes.length >= 2) {\n         const deltas = [];\n-        for (let i = 1; i < blockTimes.length; i++) deltas.push(blockTimes[i] - blockTimes[i-1]);\n-        const avgMs = deltas.reduce((a,b)=>a+b,0) / deltas.length;\n+        for (let i = 1; i < blockTimes.length; i++) deltas.push(blockTimes[i] - blockTimes[i - 1]);\n+        const avgMs = deltas.reduce((a, b) => a + b, 0) / deltas.length;\n         avgBlockSec = avgMs / 1000;\n       }\n       let estHashrate = '—';\n       try {\n@@ -120,9 +120,9 @@\n       let blockFull = null;\n       try {\n         const b = await axios.get(`${NODE_URL}/block/${tip.index}`);\n         blockFull = b.data;\n-      } catch {}\n+      } catch { }\n \n       emitAll({\n         type: 'new_block',\n         tip,\n@@ -139,9 +139,9 @@\n       try {\n         const chain = (await axios.get(`${NODE_URL}/chain`)).data;\n         const window = chain.slice(Math.max(0, chain.length - 50));\n         emitAll({ type: 'chain_window', blocks: window });\n-      } catch {}\n+      } catch { }\n     }\n \n     // mempool changes?\n     if (Array.isArray(mempool) && mempool.length !== lastMempoolCount) {\n"
                }
            ],
            "date": 1761997432137,
            "name": "Commit-0",
            "content": "// apps/scanner/webserver.js\n// Web Scanner (Vue 3 CDN) + Live updates via server-side polling -> browser WebSocket\n// Run: NODE_URL=http://localhost:3000 node apps/scanner/webserver.js\n\nconst express = require('express');\nconst path = require('path');\nconst axios = require('axios');\nconst { WebSocketServer } = require('ws');\n\nconst NODE_URL = process.env.NODE_URL || 'http://localhost:3000';\nconst PORT = process.env.SCANNER_PORT ? Number(process.env.SCANNER_PORT) : 8080;\n\nconst app = express();\n\n// -------- Static files (Vue app) --------\nconst PUB = path.join(__dirname, 'public');\napp.use(express.static(PUB));\n\n// -------- Lightweight proxy (avoid CORS) --------\napp.get('/api/tip', async (req, res) => {\n  try { res.json((await axios.get(`${NODE_URL}/tip`)).data); }\n  catch (e) { res.status(500).json({ error: e.message }); }\n});\napp.get('/api/chain', async (req, res) => {\n  try { res.json((await axios.get(`${NODE_URL}/chain`)).data); }\n  catch (e) { res.status(500).json({ error: e.message }); }\n});\napp.get('/api/mempool', async (req, res) => {\n  try { res.json((await axios.get(`${NODE_URL}/mempool`)).data); }\n  catch (e) { res.status(500).json({ error: e.message }); }\n});\napp.get('/api/block/:h', async (req, res) => {\n  try { res.json((await axios.get(`${NODE_URL}/block/${req.params.h}`)).data); }\n  catch (e) { res.status(500).json({ error: e.message }); }\n});\napp.get('/api/tx/:id', async (req, res) => {\n  try { res.json((await axios.get(`${NODE_URL}/tx/${req.params.id}`)).data); }\n  catch (e) { res.status(500).json({ error: e.message }); }\n});\n\n// -------- HTTP server --------\nconst server = app.listen(PORT, () => {\n  console.log(`[SCANNER] Web UI on http://localhost:${PORT}  (proxy to ${NODE_URL})`);\n});\n\n// -------- WS to browser clients --------\nconst wss = new WebSocketServer({ server });\nconst clients = new Set();\nwss.on('connection', (ws) => {\n  clients.add(ws);\n  console.log('[SCANNER] Client connected (WS).');\n  ws.on('close', () => clients.delete(ws));\n});\n\n// -------- Polling loop: fetch from node and push deltas --------\nlet lastHeight = -1;\nlet lastMempoolCount = 0;\nlet blockTimes = []; // ms timestamps for last N tips\nconst MOVING_N = 20;\n\nfunction bitsToTarget(bits) {\n  const exp = (bits >>> 24) & 0xff;\n  let mant = BigInt(bits & 0x007fffff);\n  if (bits & 0x00800000) mant = mant | (1n << 23n);\n  const shift = BigInt(8 * (exp - 3));\n  return mant << shift;\n}\nfunction formatHashrate(hps) {\n  if (!isFinite(hps) || hps <= 0) return '—';\n  const units = ['H/s','kH/s','MH/s','GH/s','TH/s','PH/s','EH/s'];\n  let idx = 0;\n  while (hps >= 1000 && idx < units.length-1) { hps /= 1000; idx++; }\n  return `${hps.toFixed(2)} ${units[idx]}`;\n}\nfunction emitAll(msg) {\n  const data = JSON.stringify(msg);\n  for (const ws of clients) {\n    if (ws.readyState === ws.OPEN) ws.send(data);\n  }\n}\n\nasync function tick() {\n  try {\n    const [tipRes, mpRes] = await Promise.allSettled([\n      axios.get(`${NODE_URL}/tip`),\n      axios.get(`${NODE_URL}/mempool`),\n    ]);\n    const tip = tipRes.status === 'fulfilled' ? tipRes.value.data : null;\n    const mempool = mpRes.status === 'fulfilled' ? mpRes.value.data : [];\n\n    // new block?\n    if (tip && typeof tip.index === 'number' && tip.index !== lastHeight) {\n      const prev = lastHeight;\n      lastHeight = tip.index;\n\n      // update block time moving-average\n      const now = Date.now();\n      blockTimes.push(now);\n      if (blockTimes.length > MOVING_N) blockTimes.shift();\n\n      // estimate stats\n      let avgBlockSec = NaN;\n      if (blockTimes.length >= 2) {\n        const deltas = [];\n        for (let i = 1; i < blockTimes.length; i++) deltas.push(blockTimes[i] - blockTimes[i-1]);\n        const avgMs = deltas.reduce((a,b)=>a+b,0) / deltas.length;\n        avgBlockSec = avgMs / 1000;\n      }\n      let estHashrate = '—';\n      try {\n        // Hashes per block ≈ 2^256 / target\n        const target = bitsToTarget(tip.bits >>> 0);\n        const two256 = Math.pow(2, 256);\n        const approxHashes = two256 / Number(target); // approximate double precision\n        const hps = avgBlockSec ? (approxHashes / avgBlockSec) : NaN;\n        estHashrate = formatHashrate(hps);\n      } catch { /* ignore */ }\n\n      // push full block for UI modal\n      let blockFull = null;\n      try {\n        const b = await axios.get(`${NODE_URL}/block/${tip.index}`);\n        blockFull = b.data;\n      } catch {}\n\n      emitAll({\n        type: 'new_block',\n        tip,\n        block: blockFull,\n        stats: {\n          height: tip.index,\n          bits: tip.bits,\n          avgBlockSec: isFinite(avgBlockSec) ? Number(avgBlockSec.toFixed(2)) : null,\n          estHashrate\n        }\n      });\n\n      // also send “chain window” (last ~50 blocks) for chain strip\n      try {\n        const chain = (await axios.get(`${NODE_URL}/chain`)).data;\n        const window = chain.slice(Math.max(0, chain.length - 50));\n        emitAll({ type: 'chain_window', blocks: window });\n      } catch {}\n    }\n\n    // mempool changes?\n    if (Array.isArray(mempool) && mempool.length !== lastMempoolCount) {\n      lastMempoolCount = mempool.length;\n      emitAll({ type: 'mempool', mempool });\n    }\n  } catch (e) {\n    console.error('[SCANNER] tick error:', e.message);\n    emitAll({ type: 'error', error: e.message });\n  }\n}\n\nsetInterval(tick, 1500);\n\n// initial prime (also helps when client connects slightly later)\n(async () => {\n  await tick();\n  console.log('[SCANNER] Polling started (1.5s).');\n})();\n"
        }
    ]
}