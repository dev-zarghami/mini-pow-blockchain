{
    "sourceFile": "apps/scanner/public/app.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1761987129724,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1761988720610,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,39 +1,77 @@\n-const API = '/api/address/';\n const ws = new WebSocket(`ws://${location.host}`);\n \n-ws.onmessage = (ev) => {\n+ws.onmessage = ev => {\n   const msg = JSON.parse(ev.data);\n   if (['new_block', 'mempool_tx'].includes(msg.type)) {\n-    if (window.currentAddress) loadAddress(window.currentAddress);\n+    console.log('üîÑ Update:', msg.type);\n+    loadChain();\n+    loadMempool();\n   }\n };\n \n-async function loadAddress(addr) {\n-  if (!addr) addr = document.getElementById('addr').value.trim();\n-  if (!addr) return;\n-  window.currentAddress = addr;\n-\n-  const res = await fetch(API + addr);\n+async function loadChain() {\n+  const res = await fetch('/api/chain');\n   const data = await res.json();\n+  const chainDiv = document.getElementById('chain-view');\n+  chainDiv.innerHTML = '';\n \n-  const balDiv = document.getElementById('balance');\n-  balDiv.innerHTML = `\n-    <div>üí∞ Balance: ${data.balance}</div>\n-    <div>üß© UTXOs: ${data.utxos.length}</div>\n-    <div>üìú TXs: ${data.txHistory.length}</div>\n+  data.chain.forEach(block => {\n+    const div = document.createElement('div');\n+    div.className = 'block';\n+    div.innerHTML = `\n+      <div class=\"block-header\">#${block.index}</div>\n+      <div>${new Date(block.timestamp).toLocaleTimeString()}</div>\n+      <div class=\"block-hash\">${block.hash.slice(0, 12)}...</div>\n+      <div>‚õèÔ∏è ${block.transactions.length} txs</div>\n+    `;\n+    div.onclick = () => showBlockDetails(block);\n+    chainDiv.appendChild(div);\n+  });\n+\n+  // Select the last block by default\n+  if (data.chain.length) showBlockDetails(data.chain[data.chain.length - 1]);\n+}\n+\n+function showBlockDetails(block) {\n+  document.querySelectorAll('.block').forEach(b => b.classList.remove('selected'));\n+  const blocks = [...document.querySelectorAll('.block')];\n+  const index = blocks.findIndex(b => b.querySelector('.block-header').innerText === `#${block.index}`);\n+  if (index >= 0) blocks[index].classList.add('selected');\n+\n+  const detail = document.getElementById('block-details');\n+  detail.innerHTML = `\n+    <h3>üß± Block #${block.index}</h3>\n+    <p><b>Hash:</b> ${block.hash}</p>\n+    <p><b>Previous:</b> ${block.previousHash}</p>\n+    <p><b>Timestamp:</b> ${block.timestamp}</p>\n+    <p><b>Difficulty:</b> ${block.difficulty}</p>\n+    <p><b>Nonce:</b> ${block.nonce}</p>\n+    <h4>Transactions (${block.transactions.length}):</h4>\n+    <pre>${JSON.stringify(block.transactions, null, 2)}</pre>\n   `;\n+}\n \n-  const table = document.getElementById('txs');\n-  table.innerHTML = `\n-    <tr><th>TXID</th><th>Block</th><th>Type</th><th>Amount</th></tr>\n-  ` + data.txHistory.map(t => `\n-    <tr>\n-      <td>${t.txid.slice(0, 10)}...</td>\n-      <td>${t.block ?? '<span class=\"mempool\">mempool</span>'}</td>\n-      <td class=\"${t.net >= 0 ? 'incoming' : 'outgoing'}\">\n-        ${t.net >= 0 ? '‚ÜôÔ∏è Incoming' : '‚ÜóÔ∏è Outgoing'}\n-      </td>\n-      <td>${t.net}</td>\n-    </tr>\n-  `).join('');\n+async function loadMempool() {\n+  const res = await fetch('/api/mempool');\n+  const data = await res.json();\n+  const txDiv = document.getElementById('tx-list');\n+  txDiv.innerHTML = '<h3>üí∏ Recent Transactions</h3>';\n+  if (!data.mempool.length) {\n+    txDiv.innerHTML += '<p>No pending transactions.</p>';\n+    return;\n+  }\n+\n+  data.mempool.forEach(tx => {\n+    const t = document.createElement('div');\n+    t.className = 'tx mempool';\n+    t.innerHTML = `\n+      <div class=\"txid\">${tx.id}</div>\n+      <div>Inputs: ${tx.inputs?.length || 0} | Outputs: ${tx.outputs.length}</div>\n+      <div>Fee: ${tx.fee || 0}</div>\n+    `;\n+    txDiv.appendChild(t);\n+  });\n }\n+\n+loadChain();\n+loadMempool();\n"
                },
                {
                    "date": 1761997479662,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,77 +1,118 @@\n-const ws = new WebSocket(`ws://${location.host}`);\n+// apps/scanner/public/app.js\n \n-ws.onmessage = ev => {\n-  const msg = JSON.parse(ev.data);\n-  if (['new_block', 'mempool_tx'].includes(msg.type)) {\n-    console.log('üîÑ Update:', msg.type);\n-    loadChain();\n-    loadMempool();\n-  }\n-};\n+const { createApp, ref, reactive, onMounted } = Vue;\n \n-async function loadChain() {\n-  const res = await fetch('/api/chain');\n-  const data = await res.json();\n-  const chainDiv = document.getElementById('chain-view');\n-  chainDiv.innerHTML = '';\n+createApp({\n+  setup() {\n+    const stats = reactive({\n+      height: null,\n+      bits: null,\n+      avgBlockSec: null,\n+      estHashrate: '‚Äî',\n+    });\n+    const chainWindow = ref([]);      // ÿ¢ÿÆÿ±€åŸÜ ~50 ÿ®ŸÑÿß⁄©\n+    const mempool = ref([]);\n+    const recentConfirmed = ref([]);  // ⁄ÜŸÜÿØ tx ÿ¢ÿÆÿ± ÿßÿ≤ ÿ®ŸÑÿß⁄©‚ÄåŸáÿß\n+    const modals = reactive({ block: null, tx: null });\n \n-  data.chain.forEach(block => {\n-    const div = document.createElement('div');\n-    div.className = 'block';\n-    div.innerHTML = `\n-      <div class=\"block-header\">#${block.index}</div>\n-      <div>${new Date(block.timestamp).toLocaleTimeString()}</div>\n-      <div class=\"block-hash\">${block.hash.slice(0, 12)}...</div>\n-      <div>‚õèÔ∏è ${block.transactions.length} txs</div>\n-    `;\n-    div.onclick = () => showBlockDetails(block);\n-    chainDiv.appendChild(div);\n-  });\n+    const ws = ref(null);\n \n-  // Select the last block by default\n-  if (data.chain.length) showBlockDetails(data.chain[data.chain.length - 1]);\n-}\n+    function short(s) { return !s ? '‚Äî' : (s.length > 20 ? s.slice(0,10)+'‚Ä¶'+s.slice(-8) : s); }\n+    function shortHash(h) { return h ? (h.slice(0,10)+'‚Ä¶') : '‚Äî'; }\n+    function formatTime(ts, full=false) {\n+      try {\n+        const d = new Date(ts);\n+        return full ? d.toLocaleString() : d.toLocaleTimeString();\n+      } catch { return '‚Äî'; }\n+    }\n+    function hashOf(b) {\n+      // ÿ®ÿß€åÿØ ÿ®ÿß ŸÇÿßŸÑÿ® ŸáÿØÿ± ŸÜŸàÿØ ÿ≥ÿßÿ≤⁄Øÿßÿ± ÿ®ÿßÿ¥ÿØ:\n+      const header = `${b.index}|${b.previousHash}|${b.timestamp}|${b.merkleRoot}|${b.nonce}|${b.bits}`;\n+      const enc = new TextEncoder().encode(header);\n+      // sha256 (browser) ‚Äì ⁄ÜŸàŸÜ ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ ⁄©Ÿàÿ™ÿßŸá ÿßÿ≥ÿ™ ÿß⁄Øÿ± ÿØÿ± ÿØÿ≥ÿ™ÿ±ÿ≥ ŸÜÿ®ŸàÿØÿå ŸáŸÖÿßŸÜ merkle ÿ±ÿß ÿ®ÿ±ŸÖ€å‚Äå⁄Øÿ±ÿØÿßŸÜ€åŸÖ\n+      if (window.crypto && window.crypto.subtle) {\n+        // async hash ‚Äì ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ ŸÅŸàÿ±€åÿå ÿ®ÿ±ŸÖ€å‚Äå⁄Øÿ±ÿØÿßŸÜ€åŸÖ prevHashÿõ ÿ®ÿπÿØÿßŸã ÿ¢ŸæÿØ€åÿ™ ŸÜŸÖ€å‚Äå⁄©ŸÜ€åŸÖ ÿ™ÿß ÿ≥ÿßÿØŸá ÿ®ŸÖÿßŸÜÿØ.\n+        return b.hash || b.previousHash?.slice(0,64) || b.merkleRoot || '';\n+      } else {\n+        return b.hash || b.merkleRoot || '';\n+      }\n+    }\n \n-function showBlockDetails(block) {\n-  document.querySelectorAll('.block').forEach(b => b.classList.remove('selected'));\n-  const blocks = [...document.querySelectorAll('.block')];\n-  const index = blocks.findIndex(b => b.querySelector('.block-header').innerText === `#${block.index}`);\n-  if (index >= 0) blocks[index].classList.add('selected');\n+    async function initialLoad() {\n+      try {\n+        const [tip, chain, mp] = await Promise.all([\n+          fetch('/api/tip').then(r=>r.json()),\n+          fetch('/api/chain').then(r=>r.json()),\n+          fetch('/api/mempool').then(r=>r.json()),\n+        ]);\n+        // chain window\n+        chainWindow.value = chain.slice(Math.max(0, chain.length - 50));\n+        mempool.value = mp || [];\n+        if (tip) {\n+          stats.height = tip.index ?? null;\n+          stats.bits = tip.bits ?? null;\n+        }\n+        // build recent confirmed txs\n+        const recent = [];\n+        for (let i = chain.length - 1; i >= 0 && recent.length < 50; i--) {\n+          const b = chain[i];\n+          for (const t of b.transactions) recent.push({ tx: t, blockHeight: b.index });\n+          if (recent.length >= 50) break;\n+        }\n+        recentConfirmed.value = recent;\n+      } catch (e) {\n+        console.error('initial load error', e);\n+      }\n+    }\n \n-  const detail = document.getElementById('block-details');\n-  detail.innerHTML = `\n-    <h3>üß± Block #${block.index}</h3>\n-    <p><b>Hash:</b> ${block.hash}</p>\n-    <p><b>Previous:</b> ${block.previousHash}</p>\n-    <p><b>Timestamp:</b> ${block.timestamp}</p>\n-    <p><b>Difficulty:</b> ${block.difficulty}</p>\n-    <p><b>Nonce:</b> ${block.nonce}</p>\n-    <h4>Transactions (${block.transactions.length}):</h4>\n-    <pre>${JSON.stringify(block.transactions, null, 2)}</pre>\n-  `;\n-}\n+    function openBlock(b) { modals.block = b; }\n+    function openTx(t) { modals.tx = t; }\n \n-async function loadMempool() {\n-  const res = await fetch('/api/mempool');\n-  const data = await res.json();\n-  const txDiv = document.getElementById('tx-list');\n-  txDiv.innerHTML = '<h3>üí∏ Recent Transactions</h3>';\n-  if (!data.mempool.length) {\n-    txDiv.innerHTML += '<p>No pending transactions.</p>';\n-    return;\n-  }\n+    function reload() { initialLoad(); }\n \n-  data.mempool.forEach(tx => {\n-    const t = document.createElement('div');\n-    t.className = 'tx mempool';\n-    t.innerHTML = `\n-      <div class=\"txid\">${tx.id}</div>\n-      <div>Inputs: ${tx.inputs?.length || 0} | Outputs: ${tx.outputs.length}</div>\n-      <div>Fee: ${tx.fee || 0}</div>\n-    `;\n-    txDiv.appendChild(t);\n-  });\n-}\n+    function connectWS() {\n+      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';\n+      const url = `${protocol}://${location.host}`;\n+      ws.value = new WebSocket(url);\n+      ws.value.onopen = () => console.log('[WS] connected');\n+      ws.value.onclose = () => { console.log('[WS] closed; retrying in 2s'); setTimeout(connectWS, 2000); };\n+      ws.value.onmessage = (ev) => {\n+        try {\n+          const msg = JSON.parse(ev.data);\n+          if (msg.type === 'new_block') {\n+            // update stats\n+            if (msg.stats) {\n+              stats.height = msg.stats.height ?? stats.height;\n+              stats.bits = msg.stats.bits ?? stats.bits;\n+              stats.avgBlockSec = msg.stats.avgBlockSec ?? stats.avgBlockSec;\n+              stats.estHashrate = msg.stats.estHashrate ?? stats.estHashrate;\n+            }\n+            // append block to recentConfirmed\n+            if (msg.block) {\n+              const b = msg.block;\n+              chainWindow.value = [...chainWindow.value.filter(x=>x.index !== b.index), b]\n+                                  .sort((a,b)=>a.index-b.index)\n+                                  .slice(Math.max(0, chainWindow.value.length - 49));\n+              // push txs to recent list (limit 200)\n+              const toAdd = b.transactions.map(t => ({ tx: t, blockHeight: b.index }));\n+              recentConfirmed.value = [...toAdd, ...recentConfirmed.value].slice(0, 200);\n+            }\n+          } else if (msg.type === 'chain_window') {\n+            chainWindow.value = msg.blocks || [];\n+          } else if (msg.type === 'mempool') {\n+            mempool.value = msg.mempool || [];\n+          } else if (msg.type === 'error') {\n+            console.warn('[WS error]', msg.error);\n+          }\n+        } catch (e) { /* ignore */ }\n+      };\n+    }\n \n-loadChain();\n-loadMempool();\n+    onMounted(() => {\n+      initialLoad();\n+      connectWS();\n+    });\n+\n+    return { stats, chainWindow, mempool, recentConfirmed, modals, openBlock, openTx, short, shortHash, formatTime, hashOf, reload };\n+  }\n+}).mount('#app');\n"
                },
                {
                    "date": 1762002467496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,11 +9,11 @@\n       bits: null,\n       avgBlockSec: null,\n       estHashrate: '‚Äî',\n     });\n-    const chainWindow = ref([]);      // ÿ¢ÿÆÿ±€åŸÜ ~50 ÿ®ŸÑÿß⁄©\n+    const chainWindow = ref([]);\n     const mempool = ref([]);\n-    const recentConfirmed = ref([]);  // ⁄ÜŸÜÿØ tx ÿ¢ÿÆÿ± ÿßÿ≤ ÿ®ŸÑÿß⁄©‚ÄåŸáÿß\n+    const recentConfirmed = ref([]);\n     const modals = reactive({ block: null, tx: null });\n \n     const ws = ref(null);\n \n@@ -25,14 +25,11 @@\n         return full ? d.toLocaleString() : d.toLocaleTimeString();\n       } catch { return '‚Äî'; }\n     }\n     function hashOf(b) {\n-      // ÿ®ÿß€åÿØ ÿ®ÿß ŸÇÿßŸÑÿ® ŸáÿØÿ± ŸÜŸàÿØ ÿ≥ÿßÿ≤⁄Øÿßÿ± ÿ®ÿßÿ¥ÿØ:\n       const header = `${b.index}|${b.previousHash}|${b.timestamp}|${b.merkleRoot}|${b.nonce}|${b.bits}`;\n       const enc = new TextEncoder().encode(header);\n-      // sha256 (browser) ‚Äì ⁄ÜŸàŸÜ ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ ⁄©Ÿàÿ™ÿßŸá ÿßÿ≥ÿ™ ÿß⁄Øÿ± ÿØÿ± ÿØÿ≥ÿ™ÿ±ÿ≥ ŸÜÿ®ŸàÿØÿå ŸáŸÖÿßŸÜ merkle ÿ±ÿß ÿ®ÿ±ŸÖ€å‚Äå⁄Øÿ±ÿØÿßŸÜ€åŸÖ\n       if (window.crypto && window.crypto.subtle) {\n-        // async hash ‚Äì ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ ŸÅŸàÿ±€åÿå ÿ®ÿ±ŸÖ€å‚Äå⁄Øÿ±ÿØÿßŸÜ€åŸÖ prevHashÿõ ÿ®ÿπÿØÿßŸã ÿ¢ŸæÿØ€åÿ™ ŸÜŸÖ€å‚Äå⁄©ŸÜ€åŸÖ ÿ™ÿß ÿ≥ÿßÿØŸá ÿ®ŸÖÿßŸÜÿØ.\n         return b.hash || b.previousHash?.slice(0,64) || b.merkleRoot || '';\n       } else {\n         return b.hash || b.merkleRoot || '';\n       }\n"
                }
            ],
            "date": 1761987129724,
            "name": "Commit-0",
            "content": "const API = '/api/address/';\nconst ws = new WebSocket(`ws://${location.host}`);\n\nws.onmessage = (ev) => {\n  const msg = JSON.parse(ev.data);\n  if (['new_block', 'mempool_tx'].includes(msg.type)) {\n    if (window.currentAddress) loadAddress(window.currentAddress);\n  }\n};\n\nasync function loadAddress(addr) {\n  if (!addr) addr = document.getElementById('addr').value.trim();\n  if (!addr) return;\n  window.currentAddress = addr;\n\n  const res = await fetch(API + addr);\n  const data = await res.json();\n\n  const balDiv = document.getElementById('balance');\n  balDiv.innerHTML = `\n    <div>üí∞ Balance: ${data.balance}</div>\n    <div>üß© UTXOs: ${data.utxos.length}</div>\n    <div>üìú TXs: ${data.txHistory.length}</div>\n  `;\n\n  const table = document.getElementById('txs');\n  table.innerHTML = `\n    <tr><th>TXID</th><th>Block</th><th>Type</th><th>Amount</th></tr>\n  ` + data.txHistory.map(t => `\n    <tr>\n      <td>${t.txid.slice(0, 10)}...</td>\n      <td>${t.block ?? '<span class=\"mempool\">mempool</span>'}</td>\n      <td class=\"${t.net >= 0 ? 'incoming' : 'outgoing'}\">\n        ${t.net >= 0 ? '‚ÜôÔ∏è Incoming' : '‚ÜóÔ∏è Outgoing'}\n      </td>\n      <td>${t.net}</td>\n    </tr>\n  `).join('');\n}\n"
        }
    ]
}